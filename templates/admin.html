<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ensure inputs readable on both dark/light backgrounds */
    input, select, textarea {
      color: #111;
      background: #fff;
    }
    .table-bg { background: #0f172a; } /* darker bg behind table when desired */
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="container mx-auto p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">Admin Panel</h1>
      <div class="flex gap-4">
        <a href="/" class="text-blue-600 hover:underline">Status Board</a>
        <a href="/runs" class="text-blue-600 hover:underline">Runs (public)</a>
        <a href="/logout" class="text-red-600 hover:underline">Logout</a>
      </div>
    </div>

    <!-- Add Bus Form -->
    <section class="bg-white p-4 rounded shadow mb-6">
      <h2 class="text-lg font-semibold mb-2">Add New Bus</h2>
      <form method="POST" class="flex flex-wrap gap-2 items-center" novalidate>
        <input type="hidden" name="action" value="add">
        <input name="bus_number" placeholder="Bus #" required class="border rounded p-2 w-28" />
        <input name="driver" placeholder="Driver" class="border rounded p-2 w-48" />
        <select name="status" class="border rounded p-2 w-40">
          <option>On Route</option>
          <option>Delayed</option>
          <option>In Garage</option>
          <option>Out of Service</option>
        </select>
        <input name="notes" placeholder="Notes (optional)" class="border rounded p-2 flex-1 min-w-[200px]" />
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Add Bus</button>
      </form>
    </section>

    <!-- Buses table (inline editable) -->
    <section class="bg-white p-4 rounded shadow mb-8">
      <h2 class="text-lg font-semibold mb-2">Manage Buses</h2>
      <div class="overflow-x-auto">
        <table class="w-full table-auto text-sm border-collapse">
          <thead class="bg-gray-200">
            <tr>
              <th class="border px-2 py-2 text-left">Bus</th>
              <th class="border px-2 py-2 text-left">Driver</th>
              <th class="border px-2 py-2 text-left">Status</th>
              <th class="border px-2 py-2 text-left">Notes</th>
              <th class="border px-2 py-2">Delete</th>
            </tr>
          </thead>
          <tbody>
            {% for bus in buses %}
            <tr class="odd:bg-white even:bg-gray-50" data-bus-id="{{ bus['id'] }}">
              <td class="border px-2 py-1 align-top">{{ bus['bus_number'] }}</td>

              <!-- driver (inline) -->
              <td class="border px-2 py-1">
                <input data-field="driver" value="{{ bus['driver'] }}" class="w-full border rounded p-1" />
              </td>

              <!-- status (inline) -->
              <td class="border px-2 py-1">
                <select data-field="status" class="w-full border rounded p-1">
                  <option {% if bus['status']=="On Route" %}selected{% endif %}>On Route</option>
                  <option {% if bus['status']=="Delayed" %}selected{% endif %}>Delayed</option>
                  <option {% if bus['status']=="In Garage" %}selected{% endif %}>In Garage</option>
                  <option {% if bus['status']=="Out of Service" %}selected{% endif %}>Out of Service</option>
                </select>
              </td>

              <!-- notes (inline) -->
              <td class="border px-2 py-1">
                <input data-field="notes" value="{{ bus['notes'] }}" class="w-full border rounded p-1" />
              </td>

              <!-- delete -->
              <td class="border px-2 py-1 text-center">
                <form method="POST" onsubmit="return confirm('Delete this bus?');">
                  <input type="hidden" name="action" value="delete" />
                  <input type="hidden" name="bus_id" value="{{ bus['id'] }}" />
                  <button type="submit" class="bg-red-600 text-white px-3 py-1 rounded">Delete</button>
                </form>
              </td>
            </tr>
            {% else %}
            <tr>
              <td class="border px-2 py-4 text-center" colspan="5">No buses yet â€” add a bus above.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Runs management -->
    <section class="bg-white p-4 rounded shadow mb-8">
      <h2 class="text-lg font-semibold mb-2">Manage Outside Runs</h2>

      <!-- Add Run -->
      <form method="POST" class="flex flex-wrap gap-2 items-center mb-4" novalidate>
        <input type="hidden" name="action" value="add_run" />
        <input name="run_date" type="date" required class="border rounded p-2" />
  <input name="run_time" type="time" required class="border rounded p-2" />
  <input name="return_time" type="time" class="border rounded p-2" />
        <input name="group_name" placeholder="Group" required class="border rounded p-2" />
        <input name="destination" placeholder="Destination" required class="border rounded p-2" />
        <input name="driver" placeholder="Driver" class="border rounded p-2" />
        <input name="sub_driver" placeholder="Sub Driver" class="border rounded p-2" />
        <input name="bus_number" placeholder="Bus #" class="border rounded p-2 w-28" />
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Add Run</button>
      </form>

      <!-- Runs table -->
      <div class="overflow-x-auto">
        <table class="w-full table-auto text-sm border-collapse">
          <thead class="bg-gray-200">
            <tr>
              <th class="border px-2 py-2">Date</th>
              <th class="border px-2 py-2">Time</th>
              <th class="border px-2 py-2">Return</th>
              <th class="border px-2 py-2">Group</th>
              <th class="border px-2 py-2">Destination</th>
              <th class="border px-2 py-2">Driver</th>
              <th class="border px-2 py-2">Sub Driver</th>
              <th class="border px-2 py-2">Bus</th>
              <th class="border px-2 py-2">Delete</th>
            </tr>
          </thead>
          <tbody>
            {% for run in runs %}
            <tr class="odd:bg-white even:bg-gray-50" data-run-id="{{ run['id'] }}">
              <td class="border px-2 py-1"><input data-field="run_date" type="date" value="{{ run['run_date_raw'] }}" class="w-full border rounded p-1" /></td>
              <td class="border px-2 py-1"><input data-field="run_time" type="time" value="{{ run['run_time_raw'] }}" class="w-full border rounded p-1" /></td>
              <td class="border px-2 py-1"><input data-field="return_time" type="time" value="{{ run.get('return_time', '') }}" class="w-full border rounded p-1" /></td>
              <td class="border px-2 py-1"><input data-field="group_name" value="{{ run['group_name'] }}" class="w-full border rounded p-1" /></td>
              <td class="border px-2 py-1"><input data-field="destination" value="{{ run['destination'] }}" class="w-full border rounded p-1" /></td>
              <td class="border px-2 py-1"><input data-field="driver" value="{{ run['driver'] }}" class="w-full border rounded p-1" /></td>
              <td class="border px-2 py-1"><input data-field="sub_driver" value="{{ run['sub_driver'] }}" class="w-full border rounded p-1" /></td>
              <td class="border px-2 py-1"><input data-field="bus_number" value="{{ run['bus_number'] }}" class="w-full border rounded p-1" /></td>
              <td class="border px-2 py-1 text-center">
                <form method="POST" onsubmit="return confirm('Delete this run?');">
                  <input type="hidden" name="action" value="delete_run" />
                  <input type="hidden" name="run_id" value="{{ run['id'] }}" />
                  <button type="submit" class="bg-red-600 text-white px-3 py-1 rounded">Delete</button>
                </form>
              </td>
            </tr>
            {% else %}
            <tr>
              <td class="border px-2 py-4 text-center" colspan="8">No runs scheduled.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

  </div>

<script>
  // Auto-save inline fields for buses and runs
  document.querySelectorAll('input[data-field], select[data-field]').forEach(el => {
    el.addEventListener('change', async (e) => {
      const row = e.target.closest('tr');
      const busId = row ? row.dataset.busId : null;
      const runId = row ? row.dataset.runId : null;
      const field = e.target.dataset.field;
      const value = e.target.value;

      try {
        let res, json;
        if (busId) {
          res = await fetch('/update_bus_field', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ bus_id: busId, field, value })
          });
          json = await res.json();
        } else if (runId) {
          res = await fetch('/update_run_field', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ run_id: runId, field, value })
          });
          json = await res.json();
        }

        if (json && !json.success) {
          alert('Update failed: ' + (json.error || 'unknown'));
        }
      } catch (err) {
        console.error(err);
        alert('Network error while saving.');
      }
    });
  });
</script>
</body>
</html>
